# THIS FILE IS AUTOGENERATED -- DO NOT EDIT #
#   Edit and Re-run .ci/gitlab/template.ci.py instead       #

stages:
  - test
  - check install
  - deploy
  - update

.test_base:
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    only: ['branches', 'tags', 'triggers', 'merge-requests']
    except:
        - /^staging/.*$/i

.pytest:
    extends: .test_base
    script: .ci/gitlab/script.bash
    tags:
      - long execution time
    environment:
        name: unsafe
    after_script:
      - .ci/gitlab/after_script.bash
    artifacts:
        name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
        expire_in: 3 months
        paths:
            - src/pymortests/testdata/check_results/*/*_changed
            - coverage.xml
            - memory_usage.txt
        reports:
            junit: test_results.xml

pages:
# this needs to use a semaphore to avoid races on the docker images
# should become available with gitlab 12.6 (Dez. 17)
    extends: .docker-in-docker
    stage: deploy
    variables:
        IMAGE: ${CI_REGISTRY_IMAGE}/docs:latest
    script:
        - apk --update add make
        - .ci/gitlab/deploy_docs.bash

    # only:
    #   - master
    #   - tags
    artifacts:
        paths:
            - public
